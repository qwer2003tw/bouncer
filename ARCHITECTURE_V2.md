# Bouncer v2 æ¶æ§‹è¨ˆç•«

> **æœ€å¾Œæ›´æ–°:** 2026-01-31 12:16 UTC
> **ç‹€æ…‹:** è¦åŠƒä¸­

---

## ğŸ¯ ç›®æ¨™

**åš´æ ¼æ¨¡å¼ï¼šClawdbot é›¶ AWS æ¬Šé™ï¼Œæ‰€æœ‰å‘½ä»¤ç”± Bouncer åŸ·è¡Œ**

é˜²æ­¢ Prompt Injection ç¹éå¯©æ‰¹æ©Ÿåˆ¶ã€‚

---

## ğŸ“Š v1 vs v2 æ¶æ§‹æ¯”è¼ƒ

| é …ç›® | v1ï¼ˆç›®å‰ï¼‰ | v2ï¼ˆåš´æ ¼æ¨¡å¼ï¼‰ |
|------|------------|----------------|
| **Clawdbot AWS æ¬Šé™** | æœªå®šç¾©ï¼ˆå¯èƒ½æœ‰ï¼‰ | âŒ å®Œå…¨ç§»é™¤ |
| **å‘½ä»¤åŸ·è¡Œä½ç½®** | Bouncer Lambda | Bouncer Lambda |
| **SAFELIST å‘½ä»¤** | Bouncer è‡ªå‹•åŸ·è¡Œ | Bouncer è‡ªå‹•åŸ·è¡Œ |
| **å¯©æ‰¹å‘½ä»¤** | Bouncer å¯©æ‰¹å¾ŒåŸ·è¡Œ | Bouncer å¯©æ‰¹å¾ŒåŸ·è¡Œ |
| **ä¸€æ¬¡æ€§ Token** | âŒ ç„¡ | âœ… æœ‰ï¼ˆé˜²é‡è¤‡åŸ·è¡Œï¼‰ |
| **åŸ·è¡Œæµç¨‹** | å–®ä¸€ endpoint | åˆ†é›¢ï¼šsubmit â†’ execute |

---

## ğŸ”„ v2 æµç¨‹è¨­è¨ˆ

### æµç¨‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Clawdbot ä¸»æ©Ÿ                             â”‚
â”‚                     ï¼ˆé›¶ AWS æ¬Šé™ï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ POST /submit
                              â”‚ {"command": "aws ec2 start-instances..."}
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Bouncer Lambda                              â”‚
â”‚                                                                  â”‚
â”‚  1. é©—è­‰ Secret                                                  â”‚
â”‚  2. æª¢æŸ¥å‘½ä»¤åˆ†é¡                                                  â”‚
â”‚     â”œâ”€ BLOCKED â†’ 403 æ‹’çµ•                                        â”‚
â”‚     â”œâ”€ SAFELIST â†’ ç›´æ¥åŸ·è¡Œï¼Œè¿”å›çµæœ                              â”‚
â”‚     â””â”€ APPROVAL â†’ ç™¼ Telegram å¯©æ‰¹                               â”‚
â”‚  3. ç­‰å¾…å¯©æ‰¹ï¼ˆæˆ–è¿”å› 202 pendingï¼‰                                â”‚
â”‚  4. å¯©æ‰¹é€šé â†’ ç”Ÿæˆä¸€æ¬¡æ€§ execution_token                         â”‚
â”‚  5. è¿”å› {"status": "approved", "token": "xxx"}                  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ å¯©æ‰¹é€šé
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Clawdbot                                  â”‚
â”‚                                                                  â”‚
â”‚  æ”¶åˆ° tokenï¼Œå‘¼å« POST /execute {"token": "xxx"}                 â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ POST /execute
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Bouncer Lambda                              â”‚
â”‚                                                                  â”‚
â”‚  1. é©—è­‰ tokenï¼ˆDynamoDB æŸ¥è©¢ï¼‰                                   â”‚
â”‚     â”œâ”€ ä¸å­˜åœ¨ â†’ 403                                              â”‚
â”‚     â”œâ”€ å·²ä½¿ç”¨ â†’ 403                                              â”‚
â”‚     â””â”€ æœ‰æ•ˆ â†’ ç¹¼çºŒ                                               â”‚
â”‚  2. æ¨™è¨˜ token ç‚ºå·²ä½¿ç”¨                                          â”‚
â”‚  3. åŸ·è¡Œå‘½ä»¤                                                     â”‚
â”‚  4. è¿”å›çµæœ                                                     â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                         åŸ·è¡Œçµæœè¿”å› Clawdbot
```

---

## ğŸ” å®‰å…¨ç‰¹æ€§

### ä¸€æ¬¡æ€§ Token æ©Ÿåˆ¶

```python
# DynamoDB è¨˜éŒ„çµæ§‹
{
    "request_id": "req_abc123",
    "command": "aws ec2 start-instances --instance-ids i-xxx",
    "status": "approved",
    "execution_token": "exec_xyz789",      # æ–°å¢
    "token_used": False,                    # æ–°å¢
    "token_expires": 1706699999,            # æ–°å¢ï¼ˆ5 åˆ†é˜ï¼‰
    "created_at": 1706699700,
    "ttl": 1706700000
}
```

### Token é©—è­‰æµç¨‹

```python
def verify_execution_token(token: str) -> dict:
    # 1. æŸ¥è©¢ DynamoDB
    item = table.query(IndexName='token-index', token=token)
    
    # 2. é©—è­‰
    if not item:
        return {"valid": False, "reason": "Token ä¸å­˜åœ¨"}
    if item["token_used"]:
        return {"valid": False, "reason": "Token å·²ä½¿ç”¨"}
    if item["token_expires"] < now():
        return {"valid": False, "reason": "Token å·²éæœŸ"}
    
    # 3. æ¨™è¨˜ç‚ºå·²ä½¿ç”¨ï¼ˆåŸå­æ“ä½œï¼‰
    table.update_item(
        Key={"request_id": item["request_id"]},
        UpdateExpression="SET token_used = :t",
        ConditionExpression="token_used = :f",  # é˜²æ­¢ä¸¦ç™¼
        ExpressionAttributeValues={":t": True, ":f": False}
    )
    
    return {"valid": True, "command": item["command"]}
```

---

## ğŸ“ ç¨‹å¼ç¢¼è®Šæ›´æ¸…å–®

### src/app.py ä¿®æ”¹

| å‡½æ•¸ | è®Šæ›´ |
|------|------|
| `lambda_handler` | æ–°å¢ `/execute` è·¯ç”± |
| `handle_clawdbot_request` | å¯©æ‰¹å¾Œç”Ÿæˆ tokenï¼Œä¸ç›´æ¥åŸ·è¡Œ |
| `handle_execute_request` | **æ–°å¢** - é©—è­‰ token ä¸¦åŸ·è¡Œ |
| `generate_execution_token` | **æ–°å¢** - ç”Ÿæˆå®‰å…¨éš¨æ©Ÿ token |
| `verify_execution_token` | **æ–°å¢** - é©—è­‰ä¸¦æ¨™è¨˜ token |
| `handle_telegram_webhook` | å¯©æ‰¹å¾Œç”Ÿæˆ tokenï¼Œæ›´æ–°è¨Šæ¯ |

### template.yaml ä¿®æ”¹

| é …ç›® | è®Šæ›´ |
|------|------|
| DynamoDB GSI | æ–°å¢ `token-index` ç”¨æ–¼ token æŸ¥è©¢ |
| IAM Policy | ç„¡è®Šæ›´ï¼ˆå·²æœ‰ AWS åŸ·è¡Œæ¬Šé™ï¼‰ |

### tests/test_bouncer.py æ–°å¢

| æ¸¬è©¦é¡ | èªªæ˜ |
|--------|------|
| `TestExecutionToken` | Token ç”Ÿæˆã€é©—è­‰ã€éæœŸã€é‡è¤‡ä½¿ç”¨ |
| `TestExecuteEndpoint` | /execute endpoint æ¸¬è©¦ |
| `TestTokenSecurity` | ä¸¦ç™¼ã€å½é€ ã€éæœŸæ”»æ“Šæ¸¬è©¦ |

---

## ğŸ”§ API è®Šæ›´

### æ–°å¢ Endpoint: POST /execute

**Request:**
```json
{
    "token": "exec_xyz789"
}
```

**Response (æˆåŠŸ):**
```json
{
    "status": "executed",
    "result": "...",
    "request_id": "req_abc123"
}
```

**Response (å¤±æ•—):**
```json
{
    "status": "error",
    "reason": "Token å·²ä½¿ç”¨"
}
```

### ä¿®æ”¹ Endpoint: POST /submit

**Response (å¯©æ‰¹é€šé - æ–°å¢ token):**
```json
{
    "status": "approved",
    "request_id": "req_abc123",
    "execution_token": "exec_xyz789",
    "token_expires_in": 300
}
```

---

## ğŸ“‹ Clawdbot æ•´åˆè®Šæ›´

### TOOLS.md æ›´æ–°

```markdown
## ğŸ” Bouncer - AWS å‘½ä»¤å¯©æ‰¹åŸ·è¡Œ

**é‡è¦ï¼šæœ¬ä¸»æ©Ÿç„¡ AWS æ¬Šé™ï¼Œæ‰€æœ‰ AWS å‘½ä»¤å¿…é ˆé€é Bouncer**

### åŸ·è¡Œæµç¨‹

1. **æäº¤å‘½ä»¤ï¼š**
   ```bash
   curl -X POST "$BOUNCER_URL/submit" \
     -H "X-Approval-Secret: $SECRET" \
     -d '{"command": "aws ...", "wait": true}'
   ```

2. **æ”¶åˆ° tokenï¼ˆå¯©æ‰¹é€šéï¼‰ï¼š**
   ```json
   {"status": "approved", "execution_token": "exec_xxx"}
   ```

3. **åŸ·è¡Œå‘½ä»¤ï¼š**
   ```bash
   curl -X POST "$BOUNCER_URL/execute" \
     -H "X-Approval-Secret: $SECRET" \
     -d '{"token": "exec_xxx"}'
   ```

4. **æ”¶åˆ°çµæœï¼š**
   ```json
   {"status": "executed", "result": "..."}
   ```

### âš ï¸ ç¦æ­¢äº‹é …

- ä¸è¦å˜—è©¦ç›´æ¥åŸ·è¡Œ `aws` å‘½ä»¤ï¼ˆæœƒå¤±æ•—ï¼‰
- ä¸è¦é‡è¤‡ä½¿ç”¨ tokenï¼ˆä¸€æ¬¡æ€§ï¼‰
- ä¸è¦åœ¨ token éæœŸå¾Œä½¿ç”¨ï¼ˆ5 åˆ†é˜ï¼‰
```

---

## ğŸš€ å¯¦ä½œé †åº

### Phase 1: æ ¸å¿ƒä¿®æ”¹ï¼ˆ30 åˆ†é˜ï¼‰

1. [ ] æ–°å¢ `generate_execution_token()` å‡½æ•¸
2. [ ] æ–°å¢ `verify_execution_token()` å‡½æ•¸
3. [ ] æ–°å¢ `handle_execute_request()` å‡½æ•¸
4. [ ] ä¿®æ”¹ `lambda_handler()` è·¯ç”±
5. [ ] ä¿®æ”¹ `handle_clawdbot_request()` - å¯©æ‰¹å¾Œè¿”å› token
6. [ ] ä¿®æ”¹ `handle_telegram_webhook()` - å¯©æ‰¹å¾Œç”Ÿæˆ token

### Phase 2: DynamoDB ä¿®æ”¹ï¼ˆ10 åˆ†é˜ï¼‰

1. [ ] template.yaml æ–°å¢ GSI `token-index`
2. [ ] æ›´æ–° DynamoDB è¨˜éŒ„çµæ§‹

### Phase 3: æ¸¬è©¦ï¼ˆ20 åˆ†é˜ï¼‰

1. [ ] æ–°å¢ `TestExecutionToken` æ¸¬è©¦é¡
2. [ ] æ–°å¢ `TestExecuteEndpoint` æ¸¬è©¦é¡
3. [ ] æ–°å¢ `TestTokenSecurity` æ¸¬è©¦é¡
4. [ ] ç¢ºèªè¦†è“‹ç‡ â‰¥ 85%

### Phase 4: æ–‡ä»¶æ›´æ–°ï¼ˆ10 åˆ†é˜ï¼‰

1. [ ] æ›´æ–° README.md
2. [ ] æ›´æ–° HANDOFF.md
3. [ ] æ›´æ–° TOOLS_TEMPLATE.md
4. [ ] æ›´æ–° PLAN.md

---

## âš ï¸ ç ´å£æ€§è®Šæ›´

| é …ç›® | å½±éŸ¿ |
|------|------|
| API Response | `wait=true` ä¸å†ç›´æ¥è¿”å›çµæœï¼Œéœ€è¦äºŒæ¬¡å‘¼å« `/execute` |
| Clawdbot æ•´åˆ | éœ€è¦ä¿®æ”¹å‘¼å«é‚è¼¯ |
| ä¸»æ©Ÿ AWS æ¬Šé™ | éƒ¨ç½²å¾Œéœ€ç§»é™¤ä¸»æ©Ÿ AWS credentials |

---

## âœ… ç¢ºèªå•é¡Œ

åŸ·è¡Œå‰è«‹ç¢ºèªï¼š

1. **v2 æµç¨‹æ˜¯å¦ç¬¦åˆé æœŸï¼Ÿ**
   - å¯©æ‰¹ â†’ æ‹¿ token â†’ å‘¼å« /execute â†’ å¾—çµæœ

2. **SAFELIST å‘½ä»¤æ˜¯å¦ä¹Ÿè¦ tokenï¼Ÿ**
   - ç›®å‰è¨­è¨ˆï¼šSAFELIST ç›´æ¥åŸ·è¡Œè¿”å›ï¼ˆä¸éœ€ tokenï¼‰
   - å¦‚æœè¦æ›´åš´æ ¼ï¼Œå¯ä»¥æ”¹æˆéƒ½éœ€è¦ token

3. **Token æœ‰æ•ˆæœŸ 5 åˆ†é˜æ˜¯å¦åˆé©ï¼Ÿ**

---

*Bouncer v2 Architecture Plan | 2026-01-31 12:16 UTC*
