# Implementation Plan: Unified DynamoDB Item Display Summary

**Branch**: `feat/unified-display-summary` | **Date**: 2026-02-25 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `specs/unified-display-summary/spec.md`

## Summary

Add a `display_summary` field to all DynamoDB approval request items at creation time, and update the "already processed" callback path in `app.py` to read it first (with fallback to existing action-type detection logic for legacy items).

## Technical Context

**Language/Version**: Python 3.11+
**Primary Dependencies**: boto3, DynamoDB
**Storage**: DynamoDB (single `bouncer-approvals` table)
**Testing**: pytest (694 tests, all must pass)
**Target Platform**: AWS Lambda
**Project Type**: Serverless API (Lambda + API Gateway + Telegram webhook)
**Constraints**: Lambda 60s timeout, items have TTL, backward compatible with legacy items

## Constitution Check

*GATE: Must pass before Phase 0 research.*

Constitution is a template (not customized for this project). No specific gates to check.
Proceeding with standard software engineering best practices.

## Project Structure

### Documentation (this feature)

```text
specs/unified-display-summary/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── tasks.md             # Task list (generated by /speckit.tasks)
└── checklists/
    └── requirements.md  # Spec quality checklist
```

### Source Code (repository root)

```text
src/
├── app.py               # Main Lambda handler — "already processed" display logic
├── mcp_execute.py       # Execute pipeline — add display_summary to item creation
├── mcp_upload.py        # Upload pipeline — add display_summary to single + batch upload
├── mcp_admin.py         # Admin tools — add display_summary to add/remove account
├── deployer.py          # Deploy pipeline — add display_summary to deploy item creation
└── ...

tests/
├── test_bouncer.py      # Main test file (most tests here)
├── test_upload_trust.py # Upload trust tests
└── ...
```

**Structure Decision**: Existing project structure. Modifications are in-place to existing files. No new files needed except potentially a helper function.

## Design Decisions

### 1. Where to generate display_summary

Generate at item creation time (in each `put_item` call) rather than at display time. This ensures:
- Consistency: same format regardless of where it's read
- Performance: no re-computation on every callback
- Auditability: the summary is stored with the item

### 2. Helper function approach

Create a single `generate_display_summary(action, item_data)` helper function in `utils.py` to centralize the format logic. Each `put_item` call site will call this function.

Alternative considered: inline format strings at each call site. Rejected because:
- DRY violation
- Format changes would require updating 6+ locations

### 3. Fallback strategy for legacy items

In `app.py`'s already-processed path:
1. Check `item.get('display_summary')` first
2. If missing, fall back to existing action-type detection logic (current code)
3. This ensures backward compatibility

### 4. display_summary format per type

| Action Type | Format | Example |
|------------|--------|---------|
| execute | `command[:100]` | `aws s3 ls --region us-east-1` |
| upload | `upload: {filename} ({size_human})` | `upload: index.html (12.00 KB)` |
| upload_batch | `upload_batch ({file_count} 個檔案, {total_size_human})` | `upload_batch (9 個檔案, 245.00 KB)` |
| add_account | `add_account: {name} ({account_id})` | `add_account: Dev (992382394211)` |
| remove_account | `remove_account: {name} ({account_id})` | `remove_account: Dev (992382394211)` |
| deploy | `deploy: {project_id}` | `deploy: bouncer` |

## Complexity Tracking

No violations. This is a straightforward enhancement adding a single field to existing items.
