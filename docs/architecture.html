<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Bouncer Architecture</title>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #1a1a2e; color: #eee; }
  h1 { text-align: center; color: #e94560; }
  h2 { color: #0f3460; background: #e94560; padding: 8px 16px; border-radius: 6px; margin-top: 40px; }
  .mermaid { background: #fff; border-radius: 12px; padding: 20px; margin: 16px 0; }
</style>
</head>
<body>
<script>mermaid.initialize({startOnLoad:true, theme:'default', securityLevel:'loose'});</script>

<h1>ğŸ” Bouncer v3.0.0 â€” Architecture</h1>

<h2>1. æ•´é«”æ¶æ§‹</h2>
<div class="mermaid">
graph TB
    subgraph Clients["å®¢æˆ¶ç«¯"]
        Agent["ğŸ¤– OpenClaw Agent<br/>(Private Bot)"]
        Steven["ğŸ‘¤ Steven<br/>(Telegram å¯©æ‰¹è€…)"]
    end
    subgraph LocalMCP["æœ¬æ©Ÿ"]
        MCP["bouncer_mcp.py<br/>(MCP Server / stdio)"]
    end
    subgraph AWS["AWS us-east-1"]
        subgraph APIGW["API Gateway REST"]
            EP_MCP["POST /mcp"]
            EP_WH["POST /webhook"]
            EP_REST["POST /"]
            EP_STATUS["GET /status/:id"]
        end
        subgraph Lambda["Lambda: bouncer-prod-function<br/>Python 3.9 ARM64 256MB 900s"]
            subgraph Pipeline["è«‹æ±‚è™•ç† Pipeline"]
                Compliance["1 Compliance<br/>Checker"]
                Blocked["2 Blocked<br/>Patterns"]
                AutoApprove["3 Auto<br/>Approve"]
                RateLimit["4 Rate<br/>Limit"]
                Trust["5 Trust<br/>Session"]
                SmartApproval["6 Smart<br/>Approval"]
            end
            AuditLog["Audit Logging"]
            CmdExec["Command Execution"]
        end
        subgraph DDB["DynamoDB"]
            Requests["requests<br/>TTL PITR GSI"]
            Accounts["accounts<br/>PITR"]
            CmdHist["command-history<br/>TTL PITR"]
            Shadow["shadow-approvals<br/>TTL"]
        end
        subgraph Deploy["Deployer Stack"]
            SFn["Step Functions"]
            CB["CodeBuild"]
            CFN_D["CloudFormation"]
            S3["S3 Artifacts<br/>KMS Versioning"]
            DeployDDB["projects / history / locks"]
        end
        subgraph Monitor["ç›£æ§"]
            Alarms["CloudWatch Alarms"]
            XRay["X-Ray"]
            DLQ["SQS DLQ"]
        end
        subgraph XAcct["Cross-Account"]
            Dev["Dev 992382394211"]
            First["1st 841882238387"]
            LT["LT 811246247192"]
        end
    end
    subgraph TG["Telegram"]
        TGBot["Bouncer Bot"]
        TGMsg["å¯©æ‰¹è¨Šæ¯"]
    end
    Agent -->|MCP stdio| MCP
    MCP -->|HTTPS| EP_MCP
    Steven -->|æŒ‰éˆ•| TGBot
    TGBot -->|Webhook| EP_WH
    EP_MCP --> Lambda
    EP_WH --> Lambda
    EP_REST --> Lambda
    EP_STATUS --> Lambda
    Compliance -->|pass| Blocked
    Blocked -->|pass| AutoApprove
    AutoApprove -->|pass| RateLimit
    RateLimit -->|pass| Trust
    Trust -->|pass| SmartApproval
    SmartApproval -->|pending| TGMsg
    Lambda --> AuditLog
    AuditLog --> Requests
    Lambda --> CmdExec
    CmdExec -->|STS AssumeRole| XAcct
    Lambda --> DDB
    Lambda -->|Start| SFn
    SFn --> CB
    CB --> S3
    CB --> CFN_D
    SFn -->|é€šçŸ¥| TGBot
    CB --> DeployDDB
    Alarms --> Monitor
    Lambda --> DLQ
    style Pipeline fill:#e8f5e9,stroke:#2e7d32
    style Lambda fill:#fff3e0,stroke:#ef6c00
    style DDB fill:#e3f2fd,stroke:#1565c0
    style Deploy fill:#f3e5f5,stroke:#7b1fa2
    style XAcct fill:#e0f2f1,stroke:#00695c
    style Monitor fill:#fce4ec,stroke:#c62828
</div>

<h2>2. è«‹æ±‚è™•ç† Pipeline</h2>
<div class="mermaid">
flowchart LR
    REQ["æ”¶åˆ°å‘½ä»¤"] --> C1
    subgraph Pipeline["6 å±¤éæ¿¾"]
        C1["Compliance<br/>Checker"] -->|é•è¦| R1["æ‹’çµ•<br/>compliance_violation"]
        C1 -->|é€šé| C2["Blocked<br/>Patterns"]
        C2 -->|åŒ¹é…| R2["æ‹’çµ•<br/>blocked"]
        C2 -->|é€šé| C3["Auto<br/>Approve"]
        C3 -->|å®‰å…¨å‘½ä»¤| R3["è‡ªå‹•åŸ·è¡Œ<br/>auto_approved"]
        C3 -->|é€šé| C4["Rate<br/>Limit"]
        C4 -->|è¶…é™| R4["æ‹’çµ•<br/>rate_limited"]
        C4 -->|é€šé| C5["Trust<br/>Session"]
        C5 -->|ä¿¡ä»»æœŸ| R5["è‡ªå‹•åŸ·è¡Œ<br/>trust_approved"]
        C5 -->|é€šé| C6["Smart<br/>Approval"]
    end
    C6 -->|Shadowè¨˜éŒ„| SHADOW["Shadow Approvals"]
    C6 -->|pending| TG["Telegram å¯©æ‰¹"]
    TG -->|æ‰¹å‡†| EXEC["åŸ·è¡Œ manual_approved"]
    TG -->|ä¿¡ä»»10åˆ†| TRUST["åŸ·è¡Œ + Trust Session"]
    TG -->|æ‹’çµ•| DENY["æ‹’çµ• manual_denied"]
    style R1 fill:#ffcdd2
    style R2 fill:#ffcdd2
    style R3 fill:#c8e6c9
    style R4 fill:#ffcdd2
    style R5 fill:#c8e6c9
    style EXEC fill:#c8e6c9
    style TRUST fill:#c8e6c9
    style DENY fill:#ffcdd2
    style SHADOW fill:#e1bee7
</div>

<h2>3. IAM æ¬Šé™çµæ§‹ (ç¾ç‹€ vs ç†æƒ³)</h2>
<div class="mermaid">
graph TB
    subgraph Current["ç¾ç‹€ - Lambda Role"]
        P1["DynamoDB CRUD x7"]
        P2["STS AssumeRole"]
        P3["Step Functions"]
        P4["SQS DLQ"]
        P5["Action: * Resource: *<br/>âš  PowerUser"]
        P6["Deny IAM å±éšªæ“ä½œ<br/>âš  ä¸å®Œæ•´"]
    end
    subgraph Ideal["ç†æƒ³ - æ–¹æ¡ˆ A"]
        IR1["Lambda Role<br/>åªæœ‰ç‡Ÿé‹æ¬Šé™"]
        IR2["BouncerExecRole<br/>Default å¸³è™Ÿ"]
        IR3["BouncerExecRole<br/>Cross-Account"]
    end
    Current -->|"Default å¸³è™Ÿç›´æ¥ç”¨<br/>âš  é€™å°±æ˜¯è¦ * çš„åŸå› "| Exec1["åŸ·è¡Œ AWS CLI"]
    Current -->|"Cross-Account<br/>assume role âœ…"| Exec2["åŸ·è¡Œ AWS CLI"]
    IR1 -->|assume role| IR2
    IR1 -->|assume role| IR3
    IR2 --> Exec3["åŸ·è¡Œ AWS CLI"]
    IR3 --> Exec4["åŸ·è¡Œ AWS CLI"]
    style P5 fill:#ffcdd2,stroke:#c62828
    style P6 fill:#fff9c4,stroke:#f57f17
    style Ideal fill:#e8f5e9,stroke:#2e7d32
    style Current fill:#fff3e0,stroke:#ef6c00
</div>

<h2>4. Deployer éƒ¨ç½²æµç¨‹</h2>
<div class="mermaid">
sequenceDiagram
    participant Agent as Agent
    participant Bouncer as Lambda
    participant TG as Telegram
    participant Steven as Steven
    participant SFn as Step Functions
    participant CB as CodeBuild
    participant S3 as S3
    participant CFN as CloudFormation
    Agent->>Bouncer: bouncer_deploy(project, reason)
    Bouncer->>Bouncer: é©—è­‰å°ˆæ¡ˆ + æª¢æŸ¥é–
    Bouncer->>TG: ç™¼é€éƒ¨ç½²å¯©æ‰¹è«‹æ±‚
    TG->>Steven: [ç¢ºèªéƒ¨ç½²] [æ‹’çµ•]
    Steven->>TG: é»æ“Šç¢ºèª
    TG->>Bouncer: Webhook callback
    Bouncer->>Bouncer: å–å¾—é– DDB conditional write
    Bouncer->>SFn: StartExecution
    SFn->>CB: å•Ÿå‹•å»ºç½®
    CB->>S3: ä¸‹è¼‰ sam_deploy.py
    CB->>CB: git clone + sam build
    CB->>CFN: sam deploy
    CFN-->>CB: éƒ¨ç½²å®Œæˆ
    CB-->>SFn: å»ºç½®æˆåŠŸ
    SFn->>TG: éƒ¨ç½²æˆåŠŸé€šçŸ¥
    SFn->>Bouncer: é‡‹æ”¾é–
</div>

<h2>5. CI/CD Pipeline</h2>
<div class="mermaid">
graph LR
    subgraph GH["GitHub Actions"]
        Push["git push"] --> Lint["ruff lint"]
        Push --> Security["bandit security"]
        Push --> CFNLint["cfn-lint âš "]
        Push --> Test["pytest 519 tests"]
    end
    subgraph Dep["éƒ¨ç½² æ‰‹å‹•è§¸ç™¼"]
        Agent2["Agent"] -->|bouncer_deploy| Bouncer2["Bouncer API"]
        Bouncer2 -->|å¯©æ‰¹| TG2["Telegram"]
        TG2 -->|ç¢ºèª| SFn2["Step Functions"]
        SFn2 --> CB2["CodeBuild"]
        CB2 --> CFN2["SAM Deploy"]
    end
    Test -->|ç„¡ coverage gate| Manual["æ‰‹å‹•æ±ºå®š"]
    Manual --> Dep
    style CFNLint fill:#fff9c4
    style Manual fill:#fff9c4
</div>

</body>
</html>
